<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³¨ëª© AR ìŠ¤íƒ¬í”„ íˆ¬ì–´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/html5-qrcode"></script>

  <!-- âœ… data.jsë¥¼ ë¨¼ì € -->
  <script src="data.js"></script>
</head>

<body>

<header>
  <h1>ğŸ“ ê³¨ëª© AR ìŠ¤íƒ¬í”„ íˆ¬ì–´</h1>
  <p>QRì„ ìŠ¤ìº”í•˜ê³  ì´ì•¼ê¸°ë¥¼ ìˆ˜ì§‘í•˜ì„¸ìš”</p>
</header>

<main>
  <button id="switchCamBtn">ğŸ”„ ì¹´ë©”ë¼ ì „í™˜</button>

  <section id="qrSection">
    <div id="reader"></div>
    <p id="status">ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</p>
  </section>

  <section id="myStamps">
    <h2>ğŸ† ë‚´ ìŠ¤íƒ¬í”„</h2>
    <div id="stampList"></div>
  </section>
</main>

<!-- âœ… QR ë¡œì§ì€ ë§¨ ì•„ë˜ -->
<script>
let currentCameraIndex = 0;
let cameras = [];
let qr;
let isProcessing = false; // ğŸ”’ ì¤‘ë³µ ë°©ì§€

async function startQr(cameraId) {
  // âŒ stop / clear ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ
  qr = new Html5Qrcode("reader");

  await qr.start(
    cameraId,
    {
      fps: 10,
      qrbox: { width: 220, height: 220 }
    },
    (qrText) => {
      if (isProcessing) return;
      isProcessing = true;

      navigator.vibrate?.(200);

      const scanned = qrText.trim();
      const spot = Object.values(SPOTS).find(s => s.qr === scanned);

      if (!spot) {
        isProcessing = false;
        return;
      }

      console.log("âœ… QR ì¸ì‹ ì„±ê³µ:", spot.id);

      sessionStorage.setItem("currentSpot", spot.id);

      // âœ… ì´ê²ƒë§Œ í•´ë¼ (100% ì„±ê³µ)
      window.location.href = "ar.html";
    }
  );
}

window.addEventListener("DOMContentLoaded", async () => {
  cameras = await Html5Qrcode.getCameras();
  if (!cameras.length) {
    alert("ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  await startQr(cameras[currentCameraIndex].id);

  document.getElementById("switchCamBtn").onclick = async () => {
    if (isProcessing) return;

    currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
    await startQr(cameras[currentCameraIndex].id);
  };
});
</script>



<script src="app.js"></script>
<script src="index-stamps.js"></script>

</body>
</html>
